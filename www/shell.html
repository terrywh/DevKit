<!doctype html>
<html style="width: 100%; height: 100%">
    <head>
        <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="/node_modules/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet">
        <link href="/node_modules/xterm/css/xterm.css" rel="stylesheet">
        <link rel="icon" type="image/png" href="/shell/shell.png" />
    </head>
    <body style="width: 100%; height: 100%;">
        <div id="term" style="width: 100%; height: 100%;"></div>
        <script type="module">
            import "/node_modules/xterm/lib/xterm.js";
            import "/node_modules/xterm-addon-webgl/lib/xterm-addon-webgl.js";
            import "/node_modules/xterm-addon-fit/lib/xterm-addon-fit.js";
            import "/node_modules/xterm-addon-attach/lib/xterm-addon-attach.js";

            function createTerminal(session_id) {
                const term = new Terminal({
                    theme: {
                        foreground: "#c5c8c6",
                        background: "#161719",
                        cursor: "#d0d0d0",

                        black: "#000000",
                        brightBlack: "#000000",

                        red: "#fd5ff1",
                        brightRed: "#fd5ff1",

                        green: "#87c38a",
                        brightGreen: "#94fa36",

                        yellow: "#ffd7b1",
                        brightYellow: "#f5ffa8",

                        blue: "#85befd",
                        brightBlue: "#96cbfe",

                        magenta: "#b9b6fc",
                        brightMagenta: "#b9b6fc",

                        cyan: "#85befd",
                        brightCyan: "#85befd",

                        white: "#e0e0e0",
                        brightWhite: "#e0e0e0",
                    },
                    cursorStyle: "bar",
                    fontFamily: "Intel One Mono",
                    fontSize: 16,
                    lineHeight: 1.2,
                });
                const addonFit = new (FitAddon.FitAddon || FitAddon)();
                term.loadAddon(addonFit);
                term.loadAddon(new (WebglAddon.WebglAddon || WebglAddon)());

                term.open(document.getElementById("term"));
                term.focus();
                term.fit = function() {
                    addonFit.fit();
                }
                return term;
            }

            async function startShell(device_id, address) {
                const rsp = await fetch("/shell/start", {
                    headers: {
                        "Content-Type": "application/json",
                    },
                    method: "POST",
                    body: JSON.stringify({
                        "device_id": device_id || "",
                        "address": address || "",
                    }),
                });
                const payload = await rsp.json();
                if (payload.error && payload.error.code > 0) throw Error(`failed to start shell: ${payload.error.info}`);
                return payload.data
            }
            
            function createSocket(session_id, term) {
                const sock = new WebSocket(`ws://${location.host}/shell/${session_id}/socket`, "shell");
                sock.binaryType = "arraybuffer";
                // 由 TrzszAddon 接管 stream 与 Terminal 间数据交换
                const promise = new Promise((resolve) => {
                    sock.addEventListener("open", function(e) {
                        resolve(sock);
                    }, {once: true});
                    sock.addEventListener("close", function(e) {
                        term.write(`\r\n\x1b[38;5;214mConnection closed, closing windows in 5s ...\x1b[0m\r\n`);
                        if (e.reason.length > 0) {
                            term.write(`\x1b[38;5:202mReason: ${e.reason}\x1b[0m\r\n`);
                        }
                        setTimeout(() => window.close(), 4500);
                    })
                });
                return promise;
            }
            async function resize(session_id, e) {
                const rsp = await fetch(`/shell/${session_id}/resize`, {
                    method: "POST",
                    headers: {
                        "content-type": "application/json",
                    },
                    body: JSON.stringify({
                        rows: e.rows,
                        cols: e.cols,
                    }),
                });
            }

            const query = new URLSearchParams(location.search);
            const session_id = await startShell(query.get("device_id"), query.get("address"));
            const term = await createTerminal(session_id);
            const sock = await createSocket(session_id, term);
            term.loadAddon(new (AttachAddon.AttachAddon || AttachAddon)(sock));
            term.onResize(function(e) {
                resize(session_id, e)
            });
            term.fit();
            let resizeTimeout;
            window.addEventListener("resize", function(e) {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    term.fit();
                }, 300);
            })
        </script>
    </body>
</html>